*************************************************************
**************** GAELO INSTALL PROCEDURE ********************
*************************************************************

************************
***** Requirements *****
************************

Linux based distribution (tested with Ubuntu 18.04 LTS)
PHP 7.2+
MySQL 5.7+
Apache (Ngnix not support as .htaccess directive are used)
Docker-compose 
Virtualmin (not neccessary, only for convenience)

**********************
**** Install *********
**********************

Define server's root password (if not done)
	- In terminal use "passwd" command

Create virtual server in virtual min for the GaelO plateform
	- If wanted install phpmysql with install script virtualmin function
	- If HTTPS wanted use Let's encrypt

Run Apache mod for the main site :
	- In vistualmin : Server Configuration -> Website Options -> PHP Execution Mode

Upload all GaelO files (gaelo/src) in the server's root apache folder

Start the GaelO Install : 
	- Go To http://domain/install/start.php
	- Check PHP requirement (see tips 1 if tests fails)
	- Declare your database settings (address, login, pass...)
	
Once installed : Remove the /install folder for security (Important !)

First Login in GaelO
	- login = 'administrator' 
	- password = 'administrator'

**************************************
***** Install Orthanc Instances ******
**************************************

GaelO needs two orthanc session to run.
The easier way to setup is to use the Orthanc Docker script in the "orthancDockerScripts" subfolder

Edit volume storage (in docker-compose) of Orthanc-PACS if you want to store raw DICOM to a specific folder

In the default scripts parameters are  :
	- Orthanc-Pacs (Do not Edit credential, Only localhost exposed) 
		- http://localhost:8042
		- login "GaelO" pass : "GaelO" for full localhost access
		- Login "dicomWeb" password "dicomWeb" for DicomWeb Api (localhost only, securized with Lua)
	- Orthanc-Exposed
		- http://localhost:8043
		- login "php", password "GaelO" for full localhost access
		- login "external" password "GaelO"
		
The database is preset so you should't care about these settings. 
If you modified credential, edit parameter in the preference panel in admin section of GaelO

Copy the DockerScript folder on the GaelO Server
Run : 
docker-compose up --build  => To test (logs)
docker-compose up --build -d => In production  (deamon)

*****************
***** TIPS ******
*****************

-1- Tune PHP Settings
Php upload max size limit is 2Mb and overrided to 5M by htaccess root file
If you need to upload documentation over 5Mb you have to increase this settings :
- In the htaccess file if applicable
- otherwise In WebMin=>Other=>Php Configuration=>Manage=>Ressource limit and increase post and upload max size (post value needs to be > upload value)

-2- Orthanc Peer Import (Not in use in GaelO 1.0)
To use Orthanc Peer import create another subdomain (ex orthanc.domain.com +- with SSL) 
Make Reverse proxy (port 80/443 => 8042) : Virtualmin > (your default website) > Server Config > Edit Proxy Website
make exposed Orthanc local adrress (ex http://localhost:8043) as destination of this subdomain

-3- Raw DICOM access
To transfer DICOM the raw dicom data are accessible in 
/var/lib/docker/volumes/{name} or in the path specified in docker compose you set.

-4- Https Only
In virtual min for the both server go to configuration => website redirect and redirect the root / to https//domain
For the orthanc server, edit the directive website of the non ssl parameter (Service => configure website => edit directive) , remove the reverse proxy and let only the redirection
Nb : do not manually erase server as it break some features in virtualmin

-5- Install on AZURE cloud
In Azure create :  Azure Dabatase for MySQL server, virtual machine (Ubuntu 18.04 LTS) with managed hard disk
Go to parameters of MySQL managed instance and change lower_case_table_names to 2 
Open port 10000 on virtual server => networking => basic open 10 000 (have to be closed after) 
Create Database using new schemas with mySQL Workbench or phpmyadmin
Install hard disk in compute instance in azure
Once disk created and formated go to Webmin -> Hardware ->Linux RAID -> Create RAID0
Still in Webmin format the created RAID partition into XFS OR Ext4 Partition
Then mount the new md0 parition on /storage folder (create it before)
Select "Wait Until network interface up" in the mount settings
Follow Install guide to install Virtual min, virtual server and Docker with Orthanc

-6- Security
Block 10000 port for Webmin (or stop webmin)
Block all other acces than server IP to the dabatase
Block 8042 and 8043 port
Block SSH 22 port (or reserve to your own IP)

-7-Email outbound
For email sending you can use : 
- External SMTP such as SendGrid or any other => Just go to Gaelo's admin Panel => preferences and define your SMTP server
- Direct server mail outbound => used if SMTP is not selected, you may add an dkim key in the data/_config folder, the file needs to be named dkim.private (remove "_sample")

-8-Upgrade Orthanc in Docker
Stop containers
docker pull osimis/orthanc
restart containers


****************
**** Links *****
****************

Docker Install : 
https://docs.docker.com/v17.09/engine/installation/linux/docker-ce/ubuntu/#install-using-the-repository
https://docs.docker.com/compose/install/

Virtualmin : 
https://www.virtualmin.com/download.html

Email Setup and Testing :
https://www.youtube.com/watch?v=_sCqM8MivCw&t=771s
https://caillaud.fr/phpmailer-envoyer-mails-signes-dkim/
https://www.mail-tester.com


